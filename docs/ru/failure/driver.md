---
title: "Отказ жесткого диска"
description: "RustFS обеспечивает доступ для чтения и записи при частичных отказах дисков через механизм, похожий на кодирование стирания, и автоматически восстанавливает данные после замены диска."
---

# Отказ жесткого диска

RustFS обеспечивает доступ для чтения и записи при частичных отказах дисков через механизм, похожий на кодирование стирания, и автоматически восстанавливает данные после замены диска.

---

### Содержание

1. [Размонтирование неисправного диска](#1-размонтирование-неисправного-диска)
2. [Замена неисправного диска](#2-замена-неисправного-диска)
3. [Обновление `/etc/fstab` или конфигурации RustFS](#3-обновление-etcfstab-или-конфигурации-rustfs)
4. [Повторное монтирование нового диска](#4-повторное-монтирование-нового-диска)
5. [Запуск и мониторинг восстановления данных](#5-запуск-и-мониторинг-восстановления-данных)
6. [Последующие проверки и замечания](#6-последующие-проверки-и-замечания)

---

### 1) Размонтирование неисправного диска

Перед физической заменой жесткого диска необходимо сначала безопасно размонтировать неисправный диск на уровне операционной системы, чтобы избежать ошибок ввода-вывода в файловой системе или RustFS во время процесса замены.

```bash
# Предположим, неисправный диск - /dev/sdb
umount /dev/sdb
```

> **Пояснение**
>
> * При наличии нескольких точек монтирования выполните `umount` для каждой.
> * При ошибке "устройство занято" сначала остановите службу RustFS:
>
> ```bash
> systemctl stop rustfs
> ```

---

### 2) Замена неисправного диска

После физической замены неисправного диска новый диск должен быть разбит на разделы и отформатирован с той же меткой, что и у оригинального диска.

```bash
# Форматировать как ext4 и присвоить метку DISK1 (должна соответствовать оригинальной метке)
mkfs.ext4 /dev/sdb -L DISK1
```

> **Требования**
>
> * Емкость нового диска ≥ емкости оригинального диска
> * Тип файловой системы должен быть согласован с другими дисками
> * Рекомендуется использовать метку (LABEL) или UUID для монтирования, чтобы порядок дисков не зависел от перезагрузки системы

---

### 3) Обновление `/etc/fstab` или конфигурации RustFS

Убедитесь, что метки или UUID записей монтирования в `/etc/fstab` указывают на новый диск. При использовании специфичного для RustFS конфигурационного файла (например, `config.yaml`) также необходимо синхронно обновить соответствующие записи.

```bash
# Проверить текущий fstab
cat /etc/fstab

# Пример записи fstab (изменения не требуются при одинаковой метке)
LABEL=DISK1 /mnt/disk1 ext4 defaults,noatime 0 2
```

> **Совет**
>
> * При использовании UUID:
>
> ```bash
> blkid /dev/sdb
> # Получить UUID нового раздела, затем заменить соответствующее поле в fstab
> ```
> * После изменения fstab обязательно проверьте синтаксис:
>
> ```bash
> mount -a # Если нет ошибок, конфигурация корректна
> ```

---

### 4) Повторное монтирование нового диска

Выполните следующие команды для пакетного монтирования всех дисков и запуска службы RustFS:

```bash
mount -a
systemctl start rustfs
```

Подтвердите, что все диски смонтированы нормально:

```bash
df -h | grep /mnt/disk
```

> **Внимание**
>
> * Если некоторые монтирования не удались, проверьте соответствие записей fstab и меток/UUID дисков.

---

### 5) Запуск и мониторинг восстановления данных

После обнаружения нового диска RustFS автоматически или вручную запустит процесс восстановления (heal) данных. Вот пример с использованием гипотетического инструмента `rustfs-admin`:

```bash
# Проверить текущее состояние дисков
rustfs-admin disk status

# Вручную запустить восстановление нового диска
rustfs-admin heal --disk /mnt/disk1

# Отслеживать прогресс восстановления в реальном времени
rustfs-admin heal status --follow
```

Одновременно можно проверить журналы службы, чтобы подтвердить, что система распознала и начала восстановление данных:

```bash
# Для установки, управляемой systemd
journalctl -u rustfs -f

# Или проверить специальный файл журнала
tail -f /var/log/rustfs/heal.log
```

> **Пояснение**
>
> * Процесс восстановления завершается в фоновом режиме, обычно с минимальным влиянием на онлайн-доступ
> * После завершения восстановления инструмент сообщит об успехе или перечислит неудачные объекты

---

### 6) Последующие проверки и замечания

1. **Мониторинг производительности**

   * Во время восстановления ввод-вывод может слегка колебаться, рекомендуется мониторить нагрузку на диски и сеть.

2. **Пакетные отказы**

   * Если происходят множественные отказы дисков из одной партии, следует рассмотреть более частые аппаратные проверки.

3. **Регулярные учения**

   * Регулярно проводите учения, имитирующие отказы дисков, чтобы убедиться, что команда знакома с процессом восстановления.

4. **Окно обслуживания**

   * В периоды высокой частоты отказов запланируйте специальное окно обслуживания для ускорения замены и восстановления.

