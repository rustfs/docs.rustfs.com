---
title: "ハードディスクの故障"
description: "RustFSは、イレイジャーコーディングに似たメカニズムを通じて、一部のディスクに障害が発生しても読み書きアクセスを提供し、ディスク交換後に自動的にデータを修復します。"
---

# ハードディスクの故障

RustFSは、イレイジャーコーディングに似たメカニズムを通じて、一部のディスクに障害が発生しても読み書きアクセスを提供し、ディスク交換後に自動的にデータを修復します。

---

### 目次

1. [故障ディスクのアンマウント](#1-故障ディスクのアンマウント)
2. [故障ディスクの交換](#2-故障ディスクの交換)
3. [`/etc/fstab` または RustFS 設定の更新](#3-etcfstab-または-rustfs-設定の更新)
4. [新しいディスクの再マウント](#4-新しいディスクの再マウント)
5. [データヒーリングの開始と監視](#5-データヒーリングの開始と監視)
6. [事後チェックと注意事項](#6-事後チェックと注意事項)

---

### 1) 故障ディスクのアンマウント

物理的なハードディスクを交換する前に、まずオペレーティングシステムレベルで故障ディスクを安全にアンマウントし、交換プロセス中にファイルシステムやRustFSでI/Oエラーが発生しないようにします。

```bash
# 故障ディスクが /dev/sdb の場合
umount /dev/sdb
```

> **説明**
>
> * マウントポイントが複数ある場合は、それぞれ `umount` を実行してください。
> * "デバイスがビジー"エラーが発生した場合は、まずRustFSサービスを停止してください：
>
> ```bash
> systemctl stop rustfs
> ```

---

### 2) 故障ディスクの交換

物理的に故障ディスクを交換した後、新しいディスクをパーティション分割・フォーマットし、元のディスクと同じラベルを付けます。

```bash
# ext4でフォーマットし、DISK1ラベルを付ける（元のラベルと一致させる必要があります）
mkfs.ext4 /dev/sdb -L DISK1
```

> **要件**
>
> * 新しいディスクの容量 ≥ 元のディスクの容量
> * ファイルシステムタイプを他のディスクと一致させる
> * システム再起動時にディスクの順序が影響を受けないよう、ラベル（LABEL）またはUUIDでマウントすることを推奨

---

### 3) `/etc/fstab` または RustFS 設定の更新

`/etc/fstab` 内のマウントエントリのラベルまたはUUIDが新しいディスクを指していることを確認します。RustFS専用の設定ファイル（`config.yaml` など）を使用している場合は、対応するエントリも同期更新が必要です。

```bash
# 現在のfstabを確認
cat /etc/fstab

# fstabエントリの例（ラベルが同じ場合は変更不要）
LABEL=DISK1 /mnt/disk1 ext4 defaults,noatime 0 2
```

> **ヒント**
>
> * UUIDを使用する場合：
>
> ```bash
> blkid /dev/sdb
> # 新しいパーティションのUUIDを取得し、fstab内の対応フィールドを置き換える
> ```
> * fstab変更後は必ず構文を検証：
>
> ```bash
> mount -a # エラーがなければ設定が正しい
> ```

---

### 4) 新しいディスクの再マウント

以下のコマンドを実行してすべてのディスクを一括マウントし、RustFSサービスを開始します：

```bash
mount -a
systemctl start rustfs
```

すべてのディスクが正常にマウントされていることを確認：

```bash
df -h | grep /mnt/disk
```

> **注意**
>
> * 一部のマウントが失敗した場合は、fstabエントリとディスクラベル/UUIDが一致しているか確認してください。

---

### 5) データヒーリングの開始と監視

RustFSは新しいディスクを検出後、自動的または手動でデータヒーリング（heal）プロセスを開始します。以下は仮想の `rustfs-admin` ツールを使用した例です：

```bash
# 現在のディスク状態を確認
rustfs-admin disk status

# 新しいディスクのヒーリングを手動で開始
rustfs-admin heal --disk /mnt/disk1

# ヒーリング進行状況をリアルタイムで確認
rustfs-admin heal status --follow
```

同時に、サービスログを確認してシステムが認識し、データ復旧を開始していることを確認できます：

```bash
# systemd管理のインストールの場合
journalctl -u rustfs -f

# または専用ログファイルを確認
tail -f /var/log/rustfs/heal.log
```

> **説明**
>
> * ヒーリングプロセスはバックグラウンドで完了し、通常オンラインアクセスへの影響は最小限です
> * ヒーリング完了後、ツールは成功を報告するか、失敗したオブジェクトをリストアップします

---

### 6) 事後チェックと注意事項

1. **パフォーマンス監視**

   * ヒーリング期間中はI/Oが若干変動する可能性があるため、ディスクとネットワーク負荷の監視を推奨します。

2. **バッチ故障**

   * 同じバッチのディスクで複数回故障が発生した場合は、より頻繁なハードウェア点検を検討してください。

3. **定期的な演習**

   * 定期的にディスク故障を模擬した演習を行い、チームが復旧プロセスに習熟していることを確認してください。

4. **メンテナンスウィンドウ**

   * 故障率が高い時期には、専用のメンテナンスウィンドウを設定し、交換とヒーリングの速度を向上させてください。

